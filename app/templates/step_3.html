{% extends 'base.html' %}
{% block title %} Step 3 {% endblock %}

{% block content %}
<style>
    @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css");

    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #f8f9fa;
    }

    #step3-ui {
        --nav-h: 96px;
        --bg: #f8f9fa;
        --panel: #f8f9fa;
        --line: #8e8e8e;
        --text: #2f2f2f;
        --muted: #6f6f6f;
        --water:   linear-gradient(180deg, #f89a5a, #eb6218);
        --infra:   linear-gradient(180deg, #b96ec2, #8f22a6);
        --live:    linear-gradient(180deg, #43a34f, #1f7a2b);
        --disaster:linear-gradient(180deg, #67c3f2, #2f92cd);

        width: 100%;
        max-width: 100%;
        height: calc(100vh - var(--nav-h));
        max-height: calc(100vh - var(--nav-h));
        box-sizing: border-box;
        margin: 0;
        padding: 10px 16px;
        background: #f8f9fa;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--text);
        overflow: hidden;
    }

    #step3-ui * { box-sizing: border-box; }

    #step3-ui .step3-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: 100%;
        min-height: 0;
        background: var(--panel);
        border-top: 2px solid var(--line);
        border-bottom: 2px solid var(--line);
    }

    #step3-ui .panel {
        padding: 14px 16px;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    #step3-ui .left-panel { border-right: 2px solid var(--line); }

    #step3-ui .panel-heading {
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: #464646;
        margin: 0 0 10px;
    }

    #step3-ui .table-wrap {
        border: 2px solid var(--line);
        overflow-y: auto;
        background: #f8f9fa;
        flex: 1;
        min-height: 0;
    }

    #step3-ui table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    #step3-ui th {
        background: #efefef;
        color: #4c4c4c;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid #a5a5a5;
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #step3-ui td {
        padding: 4px 6px;
        font-size: 12px;
        border: 1px solid #a5a5a5;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text);
    }

    #step3-ui .icon-col { text-align: center; width: 36px; }
    #step3-ui .qty-col  { text-align: center; width: 50px; }

    #step3-ui .icon-btn {
        border: 0;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
    }

    #step3-ui .view-btn   { color: #5f5f5f; }
    #step3-ui .arrow-btn  { color: #0091ff; }
    #step3-ui .arrow-btn[disabled] { color: #c0c0c0 !important; cursor: not-allowed !important; opacity: 0.4; }
    #step3-ui .delete-btn { color: #c11414; }

    /* Qty value */
    #step3-ui .qty-value {
        font-size: 13px;
        font-weight: 700;
        color: #2f2f2f;
        text-align: center;
        display: block;
    }

    /* AAP qty badge */
    #step3-ui .aap-qty-badge {
        display: inline-block;
        background: #0091ff;
        color: #fff;
        font-size: 11px;
        font-weight: 700;
        border-radius: 10px;
        padding: 1px 7px;
        min-width: 22px;
        text-align: center;
    }

    #step3-ui .empty-row {
        text-align: center;
        color: #757575;
        padding: 18px 8px;
    }

    #step3-ui .status-msg {
        font-size: 12px;
        color: #666;
        margin: 6px 0 0;
        min-height: 16px;
        flex-shrink: 0;
    }

    /* Domain Cards */
    #step3-ui .domain-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin-top: 12px;
        flex-shrink: 0;
    }

    #step3-ui .domain-item .label {
        text-align: center;
        margin-bottom: 4px;
        font-size: 12px;
        font-weight: 700;
        min-height: 28px;
        color: var(--text);
    }

    #step3-ui .domain-item .count-card {
        height: 66px;
        border-radius: 14px;
        color: #fff;
        font-size: 30px;
        font-weight: 700;
        display: grid;
        place-items: center;
        box-shadow: inset 0 2px 7px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s;
        user-select: none;
    }

    #step3-ui .domain-item .count-card:hover { transform: scale(1.04); }

    #step3-ui .domain-item .count-card.active-filter {
        outline: 3px solid #fff;
        box-shadow: 0 0 0 5px rgba(0,0,0,0.35), inset 0 2px 7px rgba(0,0,0,0.2);
        transform: scale(1.04);
    }

    /* About Work */
    #step3-ui .about-work { margin-top: 12px; flex-shrink: 0; }

    #step3-ui .about-work h4 {
        margin: 0 0 8px;
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: #464646;
    }

    #step3-ui .about-content {
        border: 2px solid #a5a5a5;
        border-radius: 10px;
        background: #f8f9fa;
        min-height: 80px;
        max-height: 130px;
        padding: 10px;
        font-size: 12px;
        line-height: 1.35;
        white-space: pre-line;
        overflow: hidden;
        color: var(--text);
    }

    #step3-ui .about-content.muted { color: var(--muted); }

    /* Footer */
    #step3-ui .step3-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 12px;
        flex-shrink: 0;
    }

    #step3-ui .btn-back {
        height: 40px; padding: 0 24px;
        border: 2px solid #747474; border-radius: 20px;
        background: linear-gradient(180deg, #9a9a9a, #7e7e7e);
        color: #fff; font-size: 15px; font-weight: 700;
        cursor: pointer; font-family: "Trebuchet MS", "Segoe UI", sans-serif;
    }

    #step3-ui .btn-approve {
        height: 40px; padding: 0 24px;
        border: 2px solid #0070cc; border-radius: 20px;
        background: linear-gradient(180deg, #33aaff, #0070cc);
        color: #fff; font-size: 15px; font-weight: 700;
        cursor: pointer; font-family: "Trebuchet MS", "Segoe UI", sans-serif;
    }

    @media (max-width: 900px) {
        #step3-ui .step3-layout { grid-template-columns: 1fr; }
        #step3-ui .left-panel { border-right: none; border-bottom: 2px solid var(--line); }
    }
</style>

<section id="step3-ui">
    <div class="step3-layout">

        <!--Viksit Gram Panchayat Stack -->
        <div class="panel left-panel">
            <div class="panel-heading">Viksit Gram Panchayat Stack</div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Theme</th>
                            <th>Group</th>
                            <th>Work</th>
                            <th>Classification</th>
                            <th class="qty-col">Qty</th>
                            <th class="icon-col"><i class="fa-solid fa-arrow-right"></i></th>
                        </tr>
                    </thead>
                    <tbody id="schemeTableBody">
                        <tr><td colspan="6" class="empty-row">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

            <p class="status-msg" id="statusMsg">Loading CSV...</p>

            <!-- Domain Cards -->
            <div class="domain-grid">
                <div class="domain-item">
                    <div class="label">Water Security</div>
                    <div class="count-card" style="background: var(--water)" id="count-water" data-filter="water">-</div>
                </div>
                <div class="domain-item">
                    <div class="label">Rural Infrastructure</div>
                    <div class="count-card" style="background: var(--infra)" id="count-infra" data-filter="infrastructure">-</div>
                </div>
                <div class="domain-item">
                    <div class="label">Rural Livelihood</div>
                    <div class="count-card" style="background: var(--live)" id="count-live" data-filter="livelihood">-</div>
                </div>
                <div class="domain-item">
                    <div class="label">Disaster Management</div>
                    <div class="count-card" style="background: var(--disaster)" id="count-disaster" data-filter="disaster">-</div>
                </div>
            </div>
        </div>

        <!-- Annual Action Plan -->
        <div class="panel right-panel">
            <div class="panel-heading">Annual Action Plan</div>

            <div class="table-wrap">
                <table style="table-layout: fixed;">
                    <colgroup>
                        <col style="width: auto;">
                        <col style="width: auto;">
                        <col style="width: 42px;">
                        <col style="width: 36px;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Work</th>
                            <th>Theme</th>
                            <th style="text-align:center;">Qty</th>
                            <th style="text-align:center;"><i class="fa-solid fa-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody id="aapTableBody">
                        <tr><td colspan="4" class="empty-row">No work added yet.</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- About Work -->
            <div class="about-work">
                <h4>About the Work</h4>
                <div id="aboutWorkContent" class="about-content muted">
                    Select a row using the eye icon to view details.
                </div>
            </div>

            <!-- Footer -->
            <div class="step3-footer">
                <button class="btn-back" onclick="window.location.href='{{ url_for('routes.step_2') }}'">Back</button>
                <button class="btn-approve" onclick="window.location.href='{{ url_for('routes.step_4') }}'">Approve</button>
            </div>
        </div>

    </div>
</section>

<script>
(function () {

    const CSV_PATH = "/static/VBGRAMG_Final_Classified_278_Works.csv";

    const schemeTableBody  = document.getElementById("schemeTableBody");
    const aapTableBody     = document.getElementById("aapTableBody");
    const aboutWorkContent = document.getElementById("aboutWorkContent");
    const statusMsg        = document.getElementById("statusMsg");

    const countEls = {
        water:    document.getElementById("count-water"),
        infra:    document.getElementById("count-infra"),
        live:     document.getElementById("count-live"),
        disaster: document.getElementById("count-disaster")
    };

    let allRows    = [];   // full CSV rows with qty
    let aapRows    = [];   // { rowRef, qty } objects in AAP
    let activeFilter = null;

    // CSV parser
    function parseCSV(text) {
        const rows = [];
        let current = "", row = [], inQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i], next = text[i + 1];
            if (char === '"') {
                if (inQuotes && next === '"') { current += '"'; i++; }
                else { inQuotes = !inQuotes; }
            } else if (char === "," && !inQuotes) {
                row.push(current); current = "";
            } else if ((char === "\n" || char === "\r") && !inQuotes) {
                if (char === "\r" && next === "\n") { i++; }
                row.push(current); current = "";
                if (row.length > 1 || (row[0] && row[0].trim())) { rows.push(row); }
                row = [];
            } else { current += char; }
        }
        if (current.length > 0 || row.length > 0) { row.push(current); rows.push(row); }
        return rows;
    }

    function csvToObjects(csvText) {
        const matrix = parseCSV(csvText);
        if (!matrix.length) return [];
        const headers = matrix[0].map(function (h) { return h.trim(); });
        return matrix.slice(1).map(function (line) {
            const item = {};
            headers.forEach(function (header, idx) { item[header] = (line[idx] || "").trim(); });
            const work           = (item["Work Name"]       || "").trim();
            const classification = (item["Classification"]  || "").trim();
            // Deterministic qty based on work name 
            function hashQty(str) {
                let h = 0;
                for (let i = 0; i < str.length; i++) { h = (h * 31 + str.charCodeAt(i)) & 0xffff; }
                return (h % 7) + 2; // 2-8
            }
            const isRepair = work.toLowerCase().includes("repair") ||
                             work.toLowerCase().includes("maintenance");
            const qty = isRepair ? 1 : hashQty(work);
            return {
                theme:          (item["Thematic Domain"] || "").trim(),
                group:          (item["Group Name"]      || "").trim(),
                work:           work,
                classification: classification,
                totalQty:       qty,   // original max
                availQty:       qty    // remaining available
            };
        }).filter(function (r) { return r.theme && r.group && r.work; });
    }

    // Render left table
    function renderSchemeTable() {
        schemeTableBody.innerHTML = "";
        const rowsToShow = activeFilter
            ? allRows.filter(function (r) { return r.theme.toLowerCase().includes(activeFilter); })
            : allRows;

        if (!rowsToShow.length) {
            schemeTableBody.innerHTML = '<tr><td colspan="6" class="empty-row">No data available.</td></tr>';
            return;
        }

        rowsToShow.forEach(function (row) {
            const idx      = allRows.indexOf(row);
            const depleted = row.availQty <= 0;

            const tr = document.createElement("tr");
            tr.innerHTML =
                '<td>' + row.theme          + '</td>' +
                '<td>' + row.group          + '</td>' +
                '<td>' + row.work           + '</td>' +
                '<td>' + row.classification + '</td>' +
                '<td class="qty-col"><span class="qty-value" id="qty-val-' + idx + '">' + row.availQty + '</span></td>' +
                '<td class="icon-col">' +
                    '<button class="icon-btn arrow-btn" data-action="add-to-aap" data-index="' + idx + '"' +
                    (depleted ? ' disabled style="color:#c0c0c0;opacity:0.4;cursor:not-allowed;" title="No quantity left"' : '') +
                    '><i class="fa-solid fa-arrow-right"></i></button>' +
                '</td>';
            schemeTableBody.appendChild(tr);
        });
    }

    function renderAapTable() {
        aapTableBody.innerHTML = "";
        if (!aapRows.length) {
            aapTableBody.innerHTML = '<tr><td colspan="4" class="empty-row">No work added yet.</td></tr>';
            return;
        }
        aapRows.forEach(function (entry, idx) {
            const tr = document.createElement("tr");
            tr.innerHTML =
                '<td>' + entry.rowRef.work  + '</td>' +
                '<td>' + entry.rowRef.theme + '</td>' +
                '<td style="text-align:center;"><span class="aap-qty-badge">' + entry.qty + '</span></td>' +
                '<td style="text-align:center;"><button class="icon-btn delete-btn" data-action="delete-aap" data-index="' + idx + '"><i class="fa-solid fa-trash"></i></button></td>';
            aapTableBody.appendChild(tr);
        });
    }

    // Domain card counts
    function renderDomainCounts() {
        function sumQty(keyword) {
            return allRows
                .filter(function (r) { return r.theme.toLowerCase().includes(keyword); })
                .reduce(function (acc, r) { return acc + r.availQty; }, 0);
        }
        countEls.water.textContent    = sumQty("water");
        countEls.infra.textContent    = sumQty("infrastructure");
        countEls.live.textContent     = sumQty("livelihood");
        countEls.disaster.textContent = sumQty("disaster");
    }

    // Domain card filter on click
    document.querySelectorAll('.count-card[data-filter]').forEach(function (card) {
        card.addEventListener("click", function () {
            const filter = card.getAttribute("data-filter");
            if (activeFilter === filter) {
                activeFilter = null;
                document.querySelectorAll('.count-card[data-filter]').forEach(function (c) { c.classList.remove("active-filter"); });
                statusMsg.textContent = "Showing all " + allRows.length + " works.";
            } else {
                activeFilter = filter;
                document.querySelectorAll('.count-card[data-filter]').forEach(function (c) { c.classList.remove("active-filter"); });
                card.classList.add("active-filter");
                const count = allRows.filter(function (r) { return r.theme.toLowerCase().includes(filter); }).length;
                statusMsg.textContent = "Showing " + count + " works for selected domain.";
            }
            renderSchemeTable();
        });
    });

    // Show about
    function showAbout(row) {
        aboutWorkContent.classList.remove("muted");
        aboutWorkContent.textContent =
            "Theme: "          + row.theme          + "\n" +
            "Group: "          + row.group          + "\n" +
            "Work: "           + row.work           + "\n" +
            "Classification: " + row.classification + "\n" +
            "Available Qty: "  + row.availQty       + " / " + row.totalQty;
    }

    // Main click handler
    document.getElementById("step3-ui").addEventListener("click", function (e) {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.getAttribute("data-action");
        const index  = Number(btn.getAttribute("data-index"));

        // Add to AAP(arrow).... 1 qty at a time
        if (action === "add-to-aap") {
            const row = allRows[index];
            if (row.availQty <= 0) {
                statusMsg.textContent = "No quantity available for: " + row.work;
                return;
            }
            // Send 1 unit to AAP
            row.availQty--;
            const existing = aapRows.find(function (a) { return a.rowRef === row; });
            if (existing) {
                existing.qty++;
            } else {
                aapRows.push({ rowRef: row, qty: 1 });
            }
            renderAapTable();
            renderSchemeTable();
            renderDomainCounts();
            statusMsg.textContent = "Added 1 to AAP: " + row.work + " (Remaining: " + row.availQty + ")";

        //  Delete from AAP.... 1 qty at a time 
        } else if (action === "delete-aap") {
            const entry = aapRows[index];
            entry.rowRef.availQty++;
            if (entry.rowRef.availQty > entry.rowRef.totalQty) {
                entry.rowRef.availQty = entry.rowRef.totalQty;
            }
            entry.qty--;
            if (entry.qty <= 0) {
                aapRows.splice(index, 1);
            }
            renderAapTable();
            renderSchemeTable();
            renderDomainCounts();
            aboutWorkContent.classList.add("muted");
            aboutWorkContent.textContent = "Select a row using the eye icon to view details.";
            statusMsg.textContent = "Removed 1 from AAP: " + entry.rowRef.work + " (AAP remaining: " + (entry.qty || 0) + ")";
        }
    });

    // Load CSV 
    async function init() {
        try {
            const res = await fetch(CSV_PATH, { cache: "no-store" });
            if (!res.ok) throw new Error("CSV not found");
            const text = await res.text();
            allRows = csvToObjects(text);
            renderSchemeTable();
            renderDomainCounts();
            statusMsg.textContent = "Loaded " + allRows.length + " works from CSV.";
        } catch (err) {
            schemeTableBody.innerHTML = '<tr><td colspan="6" class="empty-row">Could not load CSV.</td></tr>';
            statusMsg.textContent = "Error loading CSV.";
        }
    }

    // Fit to viewport
    function fitToViewport() {
        const navbar = document.querySelector(".navbar");
        const navHeight = navbar ? navbar.offsetHeight : 96;
        document.getElementById("step3-ui").style.setProperty("--nav-h", navHeight + "px");
    }
    window.addEventListener("resize", fitToViewport);
    fitToViewport();

    init();
}());
</script>

{% endblock %}